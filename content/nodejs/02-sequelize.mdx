---
title: "Sequelize"
metaTitle: ""
metaDescription: ""
---

# ðŸ›¡ IntroduÃ§Ã£o ao Sequelize

### ORM
* AbstraÃ§Ã£o do banco de dados;
* Tabelas viram models
  * users :arrow_right: User.js
  * companies :arrow_right: Company.js
  * projects :arrow_right: Project.js

### ManipulaÃ§Ã£o dos Dados
* Sem SQL *(na maioria das vezes)*;
* Apenas cÃ³digo JavaScript;

#### Exemplo de SQL:
```sql
INSERT INTO Users (name, email)
  VALUES (
    "Leonardo Almeida",
    "leo@webid.net.br"
  )
```

#### Exemplo de JavaScript:
```js
  User.create({
    name: 'Leonardo ALmeida',
    email: 'leo@webid.net.br',
  })
  ```

### Migrations
* Controle de versÃ£o para base de dados;
* Cada arquvo contÃ©m instruÃ§Ãµes para criaÃ§Ã£o, alteraÃ§Ã£o ou remoÃ§Ã£o de tabelas ou colunas;
* MantÃ©m a base atualizada entre todos desenvolvedores do time e tambÃ©m no ambiente de produÃ§Ã£o;
* Cada arquivo Ã© uma migration e sua ordenaÃ§Ã£o ocorre por data
* :warning: A partir do momento em que a migration for passada para outro(s) desenvolvedor(es) ou para o ambiente de produÃ§Ã£o, ela nÃ£o deve mais ser editada. Para isso, cria-se novas migrations.

#### Exemplo de migration:
```js
module.expots = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.createTable('users', { // IntroduÃ§Ã£o para criar uma nova tabela.
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER
      },
      name: {                                   // CriaÃ§Ã£o do primeiro campo com suas prioridades.
        allowNull: false,                       // O ID Ã© a chave primÃ¡ria e auto incremental.
        type: Sequelize.STRING
      },
      email: {
        allowNull: false,
        unique: true,
        type: Sequelize.STRING
      }
    })
  },
  down: (queryInterface, Sequelize) => {
    return queryInterface.dropTable('users')    // InstruÃ§Ã£o para deletar a tabela caso haja um rollback.
  }
}
```
* Ã‰ possÃ­vel desfazer uma migraÃ§Ã£o se errarmos algo enquanto estivermos desenvolvendo a feature;
* Depois que a migration foi enviada para outros devs ou para ambiente de produÃ§Ã£o, ela *JAMAIS* poderÃ¡ ser alterada, uma nova deve ser criada;
* Cada migration deve realizar alteraÃ§Ãµes em apenas uma tabela, vocÃª pode criar migrations para alteraÃ§Ãµes maiores;

### Seeds
* PopulaÃ§Ã£o da base de dados para desenvolvimento;
* Muito utilizado para popular dados para testes;
* ExecutÃ¡vel apenas por cÃ³digo;
* Jamais serÃ¡ utilizado em produÃ§Ã£o;
* Caso sejam dados que precisam ir para produÃ§Ã£o, a prÃ³pria migration pode manipular dados das tabelas;

### Arquitetura MVC
* Model
  * O model armazena a abstraÃ§Ã£o do banco, utilizado para manipular os dados contidos nas tabelas do banco. NÃ£o possuem responsabilidade sobre a regra de negÃ³cio da nossa aplicaÃ§Ã£o
* Controller
  * O controller Ã© o ponto de entrada das requisiÃ§Ãµes da nossa aplicaÃ§Ã£o, uma rota geralmente estÃ¡ associada diretamente com um mÃ©todo do controller. Podemos incluir a grande parte das regras de negÃ³cio da aplicaÃ§Ã£o nos controllers (conforme a aplicaÃ§Ã£o cresce podemos isolar as regras).
* View
  * A view Ã© o retorno ao cliente, em aplicaÃ§Ãµes que nÃ£o utilizando o modelo de API REST isso pode ser um HTML, mas no nosso caso, a view Ã© apenas nosso *JSON* que serÃ¡ retornado ao front-end e depois manipulado pelo *ReactJS* ou *React Native*

  #### A face de um Controller
* Classes;
* Sempre retorna um JSON;
* NÃ£o chama outro controller/mÃ©todo;
* Quando criar um novo Controller:
  * Apenas 5 mÃ©todos;
  * Estou falando da mesma *entidade*?

##### MÃ©todos:

```js
class UserController {
  index() { }   // Listagem de usuÃ¡rios
  show() { }    // Exibir um Ãºnico usuÃ¡rio
  store() { }   // Cadastrar usuÃ¡rio
  update() { }  // Alterar usuÃ¡rio
  delete() { }  // Remover usuÃ¡rio
}
```

# InstalaÃ§Ã£o do Sequelize

### Postgres + Sequelize
`yarn add sequelize` e `yarn add sequelize-cli -D` instalarÃ¡ as dependÃªncias necessÃ¡rias para rodar o Sequelize

`yarn add pg pg-hstore` essas duas dependÃªncias sÃ£o necessÃ¡rias para integrar o Sequelize com o Postgres

### ConfiguraÃ§Ãµes do Postgres
*src/config/database.js*

```js
module.exports = {
  dialect: 'postgres',
  host: 'localhost',
  username: 'postgres',
  password: 'docker',
  database: 'gobarber',
  define: {
    timestamps: true,
    underscored: true,
    underscoredAll: true,
  },
};
```

### ConfiguraÃ§Ãµes do Sequelize
*Arquivo .sequelizerc*

```js
const { resolve } = require('path');

module.exports = {
  config:resolve(__dirname, 'src', 'config', 'database.js'),
  'models-path':resolve(__dirname, 'src', 'app', 'models'),
  'migrations-path':resolve(__dirname, 'src', 'database', 'migrations'),
  'seeders-path':resolve(__dirname, 'src', 'database', 'seeds'),
}
```

### Criando e rodando uma migration com o Sequelize
`yarn sequelize-cli migration:create --name=create-users` irÃ¡ criar uma migration com o nome *create-users* de forma prÃ©-definida.

`yarn sequelize db:migrate` serve para gerar esse banco de dados

`yarn sequelize db:migrate:undo` para dar *undo* na Ãºltima migration ou `yarn sequelize db:migrate:undo:all` para dar undo em todas as migrations

### CriaÃ§Ã£o de uma Model
*src/app/models/User.js*

Modelo de Exemplo:

```js
import Sequelize, { Model } from 'sequelize';

class User extends Model {
  static init(sequelize) {
    super.init(  // O primeiro parÃ¢metro sÃ£o os valores que o usuÃ¡rio pode receber no momento de criaÃ§Ã£o ou ediÃ§Ã£o
      {
        name: Sequelize.STRING,
        email: Sequelize.STRING,
        password_hash: Sequelize.STRING,
        provider: Sequelize.BOOLEAN,
      },
      {
        sequelize, // O segundo parÃ¢metro Ã© o sequelize passado no init, mas poderia ser passadas outras configuraÃ§Ãµes.
      }
    );
  }
}

export default User;
```

**Arquivo src/database/index.js**

```js
import Sequelize from 'sequelize';

import User from '../app/models/User';

import databaseConfig from '../config/database';

const models = [User];

class Database {
  constructor() {
    this.init();
  }

  init() {
    this.connection = new Sequelize(databaseConfig);

    models
      .map(model => model.init(this.connection))
      .map(model => model.associate && model.associate(this.connection.models));
  }
}

export default new Database();
```
